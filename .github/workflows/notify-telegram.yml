name: GitHub Issues & Comments to Telegram

on:
  issues:
    types: [opened, edited, closed, reopened]
  issue_comment:
    types: [created, edited, deleted]

jobs:
  send_to_telegram:
    runs-on: ubuntu-latest
    environment: Telegram
    if: ${{ github.event.sender.type != 'Bot' && github.event.sender.login != 'github-actions[bot]' }}

    steps:
      - name: Compose and send message
        env:
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          EVENT_NAME: ${{ github.event_name }}               # issues æˆ– issue_comment
          ACTION: ${{ github.event.action }}                 # opened/edited/closed/created/...
          ISSUE_TITLE: ${{ github.event.issue.title }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_BODY: ${{ github.event.issue.body }}
          COMMENT_BODY: ${{ github.event.comment.body }}
          SENDER: ${{ github.event.sender.login }}
        run: |
          # é€‰ç”¨æ­£æ–‡ï¼šIssue äº‹ä»¶ç”¨ ISSUE_BODYï¼Œè¯„è®ºäº‹ä»¶ç”¨ COMMENT_BODY
          if [ "$EVENT_NAME" = "issue_comment" ]; then
            BODY="$COMMENT_BODY"
            WHAT="Comment"
            URL="${ISSUE_URL}#issuecomment-${{ github.event.comment.id }}"
            TITLE="$ISSUE_TITLE"
          else
            BODY="$ISSUE_BODY"
            WHAT="Issue"
            URL="$ISSUE_URL"
            TITLE="$ISSUE_TITLE"
          fi

          # æˆªæ–­æ­£æ–‡ï¼Œé¿å…è¶…è¿‡ Telegram 4096 é™åˆ¶
          MAX=1500
          if [ -n "$BODY" ]; then
            LEN=${#BODY}
            if [ $LEN -gt $MAX ]; then
              BODY="${BODY:0:$MAX}\nâ€¦(truncated)"
            fi
          fi

          # ç»„è£…æ¶ˆæ¯ï¼ˆMarkdownï¼‰ï¼Œå°½é‡é¿å…ç‰¹æ®Šå­—ç¬¦å¯¼è‡´è§£æå¤±è´¥
          # å¦‚æœä½ é‡åˆ°è§£ææŠ¥é”™ï¼Œå¯æŠŠ parse_mode æ”¹ä¸º HTMLï¼Œæˆ–å»æ‰ parse_modeã€‚
          MESSAGE="ğŸ”” *GitHub ${WHAT} ${ACTION}* by \`${SENDER}\`
*${TITLE}*
${URL}

${BODY}"

          curl -sS -X POST "https://api.telegram.org/bot${TELEGRAM_BOT_TOKEN}/sendMessage" \
            -d chat_id="${TELEGRAM_CHAT_ID}" \
            --data-urlencode text="$MESSAGE" \
            -d parse_mode="Markdown"
